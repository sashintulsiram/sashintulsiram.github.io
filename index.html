<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">        
        <!-- Google Tag Manager -->
        <script>
            (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-TV43V3SG');
        </script>      

        <!-- Script that queries and stores the URL. Uses SearchParams reads and decode the URL to create objects (URL, parameters) -->
        <script>
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const page_url = urlParams.get('page_url')
            const key_var = urlParams.get('key')
            const value_var = urlParams.get('value')
        </script>

        <!-- Script that push Query String Parameters to GTM Data Layer -->
        <script>
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
                'key': key_var,
                'value': value_var
            });
        </script>

        <!-- Title -->
        <title>Sashin Tulsiram - Technical Manager Challenge</title>
    </head>

    <body>
        <!-- Google Tag Manager (noscript) -->
        <noscript>
            <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TV43V3SG" height="0" width="0" style="display:none;visibility:hidden">
            </iframe>
        </noscript>

        <h2>This is a Test website which performs the below functions: </h2>
        <ol>
            <li>Google Tag Manager and Query String Parameters</li>            
            <li>Testing of Other Query String Parameters</li>
            <li>API Implementation</li>            
        </ol>
        <hr>

        <h3>1. Google Tag Manager and Query String Parameters</h3>
            <ul>
                <li>The Google Tag Manager code required for the integration was added to the source code.</li> 
                <li>A JavaScript client-side script was created to read the entered URL and dynamically assign the inputted key value data into their own separate variables. This function uses URLSearchParams to read and decode the URL to create the key and value variables.</li>
                <li>A JavaScript client-side script was created to push the key and value variable data to Googles Tag Managers Data Layer.</li>
                <li>Google Tag Manager was successfully implemented and tested. The applications functionality to push data to the GTM data layer was also tested successfully.</li>
                <li>Google Tag Manager DataLayer: </li>
                <ul>
                    <li>Event: <b id="event_dataLayer_id"></b></li>
                    <li>GTM Start: <b id="gtmStart_dataLayer_id"></b></li>
                    <li>Key: <b id="key_dataLayer_id"></b></li>
                    <li>Value: <b id="value_dataLayer_id"></b></li>                    
                </ul>                
            </ul>        

            <script>
                window.dataLayer.push(function() {
                    const key_dataLayer = this.get('key');
                    const value_dataLayer = this.get('value');
                    const gtmStart_dataLayer = this.get('gtm.start');
                    const event_dataLayer = this.get('event');
                    /*const dataLayer_string = JSON.stringify(dataLayer, null, 4);
                    if (!dataLayer_string) {
                        const dataLayer_string = "Google Tag Manager DataLayer is unavailable.";
                    }             
                    document.getElementById("dataLayer_id").textContent = dataLayer_string;
                    */
                    document.getElementById("key_dataLayer_id").textContent = key_dataLayer;
                    document.getElementById("value_dataLayer_id").textContent = value_dataLayer;
                    document.getElementById("gtmStart_dataLayer_id").textContent = gtmStart_dataLayer;
                    document.getElementById("event_dataLayer_id").textContent = event_dataLayer;
                });                                                               
            </script>
        <hr>
        
        <!-- Displays the entered Query String Parameters from the URL -->            
        <h3>2. Testing of Other Query String Parameters</h3>
            <div>
                <ol>
                    <li>A JavaScript client-side script was created which references the DOM and returns two variables for the key and value as string data.</li>
                    <li>For testing purposes, follow these steps to check if key and pairs are not hardcoded. To assess if Query String Parameters are hardcoded, change the key value pair within the URL and press Enter. Confirm the following key value pair was successfully updated by referencing the below data for the inputted key and value:</li>
                        <ul>
                            <li>Key: <b id="key_id"></b></li>
                            <li>Value: <b id="value_id"></b></li>
                        </ul>
                    <li>This test ensures that key and value pairs are not hardcoded and will update automatically according to the URL parameters specified. This test was completed successfully.</li>
                </ol>

                <!-- Script that references the DOM and returns Query String Parameter (key, value) -->
                <script>
                    document.getElementById('key_id').textContent = key_var
                    document.getElementById('value_id').textContent = value_var
                </script>
            </div>
        <hr>
        
        <!-- When a user clicks the button, an onclick event is triggered which executes a function - a JavaScript function pulls Query String Parameters from the GTM Data Layer, stores these parameters into variables, Uses SearchParams encode the URL with the provided URL & parameters, send an API GET request using the constructed string, and prints the response to the console -->
        <h3>3. API Implementation</h3>
            <div>
                <ul>
                    <li>A button called “Send API Request” was added to the page which send a GET API request to http://httpbin.org/get. The following steps illustrate what happens when you interact with the button:</li>
                    <ul>
                        <li>When a user clicks on the button, an onclick event is triggered.</li>
                        <li>A JavaScript function is triggered which was created to pull the key and value data stored in GTMs data layer and stores this data into two separate variables. The function uses URLSearchParams to construct a GET API request using the variable data and provided API endpoint. Data from the API response is formatted in JSON and is logged in the console.</li>
                    </ul>
                </ul>        
                <button type="button" onclick=getData()>Send API Request!</button>
            </div>
        <hr>
        
        
        <script>
            /*
            function getData(){
                window.dataLayer.push(function() {
                    const key_dataLayer = this.get('key');
                    const value_dataLayer = this.get('value');

                    const params = new URLSearchParams({
                        key: key_dataLayer,
                        value: value_dataLayer
                });                  
                    
                const request = ( url, params = {}, method = 'GET' ) => {
                    let options = {method};
                    if ( 'GET' === method ) {
                        url += '?' + ( new URLSearchParams( params ) ).toString();
                    } 
                    else {
                        options.body = JSON.stringify( params );
                    }
                    return fetch( url, options ).then( response => response.json() );
                };

                const get = ( url, params ) => request( url, params, 'GET' );
                get( 'https://httpbin.org/get', params )
                .then(response => {
                    console.log(response)
                })
                .catch(error => {
                    console.error(error)
                });
                })
            }
            */

            async function getData(){
                //const key_dataLayer = dataLayer[1].key;
                //const value_dataLayer = dataLayer[1].value;
                
                /* Get Data from Google Tag Manager DataLayer */
                window.dataLayer.push(function() {
                    const key_dataLayer = this.get('key');
                    const value_dataLayer = this.get('value');

                    const params = new URLSearchParams({
                        key: key_dataLayer,
                        value: value_dataLayer
                });

                /* Data Validation - Key and Value Data */
                if (!key_dataLayer) {
                    alert("Please enter in a valid URL string or 'key' data. E.G. https://sashintulsiram.github.io/?key=hello&value=world")
                    return;
                }

                if (!value_dataLayer) {
                    alert("Please enter in a valid URL string or 'value' data. E.G. https://sashintulsiram.github.io/?key=hello&value=world")
                    return;
                }
                    
                /* Construct HTTP GET API Request */
                const request = ( url, params = {}, method = 'GET' ) => {
                    let options = {method};
                    if ( 'GET' === method ) {
                        url += '?' + ( new URLSearchParams( params ) ).toString();
                    } 
                    else {
                        options.body = JSON.stringify( params );
                    }
                    const response = await fetch( url, options ).then( response => response.json() );
                    console.log(response)
                };

                const get = ( url, params ) => request( url, params, 'GET' );
                get( 'https://httpbin.org/get', params )
                .then(response => {
                    console.log(response)
                })
                .catch(error => {
                    console.error("Logging error:",error)
                }); 
            })           
            }
        

        </script>               
    </body>
</html>
