<!DOCTYPE html>
<html>
    <head>
        
        <!-- Google Tag Manager -->
        <script>
            (function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
            new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
            'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
            })(window,document,'script','dataLayer','GTM-TV43V3SG');
        </script>      

        <!-- Script that queries and stores the URL. Uses SearchParams reads and decode the URL to create objects (URL, parameters) -->
        <script>
            const queryString = window.location.search;
            const urlParams = new URLSearchParams(queryString);
            const page_url = urlParams.get('page_url')
            const key = urlParams.get('key')
            const value = urlParams.get('value')
            let key_var = key
            let value_var = value                     
        </script>

        <!-- Script that push Query String Parameters to GTM Data Layer -->
        <script>
            window.dataLayer = window.dataLayer || [];
            window.dataLayer.push({
             'key': key_var,
             'value': value_var
            });
        </script>

        <!-- Title -->
        <title>Sashin Tulsiram - Technical Manager Challenge</title>
    </head>

    <body>
        <!-- Google Tag Manager (noscript) -->
        <noscript>
            <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TV43V3SG"
            height="0" width="0" style="display:none;visibility:hidden">
            </iframe>
        </noscript>

        <h2>This is a Test website which performs the below functions: </h2>
        <ol>
            <li>Google Tag Manager and Query String Parameters</li>            
            <li>Testing of Other Query String Parameters</li>
            <li>API Implementation</li>            
        </ol>

        <h3>1. Google Tag Manager and Query String Parameters</h3>
            <ul>
                <li>The Google Tag Manager code snippet required for the integration was added to the source code.</li> 
                <li>A JavaScript client-side script was created to dynamically assign the inputted key and value pair into their own separate variables (key, value).</li>
                <li>A JavaScript client-side script was created to push the key and value variable data to Googles Tag Managers Data Layer.</li>
                <li>Google Tag Manager was successfully implemented and tested. The applications functionality to push data to the GTM data layer was also tested successfully.</li>
            </ul>        

        <!-- Displays the entered Query String Parameters from the URL -->            
        <h3>2. Testing of Other Query String Parameters</h3>
            <div>
                <ol>
                    <li>A JavaScript client-side script was created which references the DOM and returns two variables for the key and value as string data.</li>
                    <li>To test if Query String Parameters are hardcoded, change the key value pair within the URL and press Enter. Confirm the following key value pair was successfully updated by referencing the below data for the inputted key and value:</li>
                        <ul>
                            <li>Key: <p id="key_id"></p></li>
                            <li>Value: <p id="value_id"></p></li>
                        </ul>
                    <li>This test ensures that key and value pairs aren't hardcoded and will update automatically according to the URL parameters specified. This test was completed successfully.</li>
                </ol>

                <!-- Script that references the DOM and returns Query String Parameter (key, value) -->
                <script>
                    document.getElementById('key_id').innerHTML = key_var
                    document.getElementById('value_id').innerHTML = value_var       
                </script>
            </div>

        <!-- When a user clicks the button, an onclick event is triggered which executes a function - a JavaScript function pulls Query String Parameters from the GTM Data Layer, stores these parameters into variables, Uses SearchParams encode the URL with the provided URL & parameters, send an API GET request using the constructed string, and prints the response to the console -->
        <h3>3. API Implementation</h3>
            <div>
                <script>
                    function getData(){
                        window.dataLayer.push(function() {
                            const key_dataLayer = this.get('key');
                            const value_dataLayer = this.get('value');

                            const params = new URLSearchParams({
                                key: key_dataLayer,
                                value: value_dataLayer
                        })                  
                        
                        const request = ( url, params = {}, method = 'GET' ) => {
                            let options = {
                                method
                            };
                            if ( 'GET' === method ) {
                                url += '?' + ( new URLSearchParams( params ) ).toString();
                            } 
                            else {
                                options.body = JSON.stringify( params );
                            }
                            return fetch( url, options ).then( response => response.json() );
                        };

                        const get = ( url, params ) => request( url, params, 'GET' );

                        get( 'https://httpbin.org/get', params )
                        .then(response => {
                            console.log(response)
                        })
                        .catch(error => {
                            console.error(error)
                        })                    
                        })
                    }
                </script>

                <button type="button" onclick=getData()>Send API Request!</button>
            </div>        
    </body>
</html>
